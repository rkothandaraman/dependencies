<?xml version="1.0" encoding="UTF-8"?>
<journeyConfig>
	<journeyID>DEC36</journeyID>
	<version>1.0.0</version>
	<!-- Journey Workflow section is provided to the Workflow Master Service (NFS mounted as a list of separate journey config files) -->
	<journeyWorkflow>
		<receive>
			<processor>InternalReceive</processor>
			<timeout>3m</timeout>
			<enabled>true</enabled>
		</receive>
		<process>
			<enabled>false</enabled>
		</process>
		<send>
			<processor>InternalSend</processor>
			<timeout>3m</timeout>
			<enabled>true</enabled>
		</send>
		<cleanup>
			<processor>InternalCleanup</processor>
			<timeout>3m</timeout>
			<enabled>true</enabled>
		</cleanup>
		<!-- 		<remoteTarget>
			<processor>service-id-for-remote-target-processing</processor>
			<timeout>10m</timeout>
		</remoteTarget> -->
	</journeyWorkflow>
	<!-- File Watcher section is provided to the File Watcher Service (NFS mounted as a list of separate journey config files) -->
	<fileWatcher>
		<schedule>0 0/5 12-18 ? * MON-FRI</schedule>
		<remoteFS>
			<remoteFSType>FTPS|SFTP|FTP|CAF|Sharepoint|S3|BlobStore</remoteFSType>
			<fileServer>server.subdomain.hmrc.gov.uk</fileServer>
			<filePath>/some/path/to/*/files</filePath>
			<filePattern>*.txt</filePattern>
			<credentials>vault-cred-id</credentials>
		</remoteFS>
		<!-- WIP -->
		<remoteFS>
			<remoteFSType>S3</remoteFSType>
			<fileServer>eu-west-2</fileServer>
			<filePath>mdg-ct/DMS/DEC36/1.0.0/from/</filePath>
			<filePattern>*.txt</filePattern>
			<credentials>
				<type>S3_ENCRYPTED</type>
				<resolverKey>vault://eis/sft/MDG/keys</resolverKey>
			</credentials>
		</remoteFS>
	</fileWatcher>
	<!-- Each Processor Config section is provided to the relevant processor (provided by the Config Service via API call) -->
	<processors>
		<!--            <processorConfig>
                <id>InternalReceive|InternalSend|ExternalReceive|ExternalSend|CustomProcessor:123|Proxy|LegacySend|LegacyReceive</id>
                <tasks>
                    <task>
                            <id>fetch-from-s3</id>
                            <....>additional config items...</...>
                        </task>
                </tasks>
            </processorConfig> -->
		<processorConfig>
			<id>InternalReceive</id>
			<tasks>
				<task>
					<id>move-within-s3</id>
					<action>MOVE</action>
					<source>
						<protocol>S3</protocol>
						<region>EU_WEST_2</region>
						<path>mdg-ct/DMS/DEC36/1.0.0/from/{filename}</path>
						<credentials>
							<type>S3_ENCRYPTED</type>
							<resolverKey>vault://eis/sft/MDG/keys</resolverKey>
						</credentials>
					</source>
					<destination>
						<protocol>S3</protocol>
						<region>EU_WEST_2</region>
						<path>mdg-ct/DMS/DEC36/1.0.0/working/{orderId}/{filename}</path>
						<credentials>
							<type>S3_ENCRYPTED</type>
							<resolverKey>vault://eis/sft/MDG/keys</resolverKey>
						</credentials>
					</destination>
					<metadataIncluded>true</metadataIncluded>
					<metadataExtension>_metadata.xml</metadataExtension>
				</task>
				<task>
					<id>download-from-s3</id>
					<action>DOWNLOAD</action>
					<source>
						<protocol>S3</protocol>
						<region>EU_WEST_2</region>
						<path>mdg-ct/DMS/DEC36/1.0.0/working/{orderId}/{filename}</path>
						<credentials>
							<type>S3_ENCRYPTED</type>
							<resolverKey>vault://eis/sft/MDG/keys</resolverKey>
						</credentials>
					</source>
					<destination>
						<protocol>localFS</protocol>
						<path>/opt/middleware/sft/temp/DEC36/1.0.0/working/{orderId}/{filename}</path>
					</destination>
					<metadataIncluded>true</metadataIncluded>
					<metadataExtension>_metadata.xml</metadataExtension>
				</task>
				<task>
					<id>validate</id>
					<action>VALIDATE</action>
					<source>
						<protocol>FS</protocol>
						<path>/opt/middleware/sft/temp/DEC36/1.0.0/working/{orderId}/{filename}</path>
					</source>
					<criteria>
						<item>
							<field>checksum</field>
							<algorithm>MD5</algorithm>
						</item>
						<item>
							<field>name</field>
							<algorithm>case-insensitive</algorithm>
						</item>
					</criteria>
				</task>
				<task>
					<id>upload-to-interim-s3</id>
					<action>UPLOAD</action>
					<source>
						<protocol>FS</protocol>
						<path>/opt/middleware/sft/temp/DEC36/1.0.0/working/{orderId}/{filename}</path>
					</source>
					<destination>
						<protocol>S3</protocol>
						<region>EU_WEST_2</region>
						<path>mdg-ct/DMS/DEC36/1.0.0/working/{orderId}/{filename}</path>
					</destination>
					<metadataIncluded>true</metadataIncluded>
					<metadataExtension>_metadata.xml</metadataExtension>
				</task>
			</tasks>
		</processorConfig>
		<processorConfig>
			<id>InternalSend</id>
			<tasks>
				<task>
					<id>download-from-s3</id>
					<action>DOWNLOAD</action>
					<source>
						<protocol>S3</protocol>
						<region>EU_WEST_2</region>
						<path>mdg-ct/DMS/DEC36/1.0.0/working/{orderId}/{filename}</path>
						<credentials>
							<type>S3_ENCRYPTED</type>
							<resolverKey>vault://eis/sft/MDG/keys</resolverKey>
						</credentials>
					</source>
					<destination>
						<protocol>FS</protocol>
						<path>/opt/middleware/sft/temp/DEC36/1.0.0/working/{orderId}/{filename}</path>
					</destination>
					<metadataIncluded>true</metadataIncluded>
					<metadataExtension>_metadata.xml</metadataExtension>
				</task>
				<task>
					<id>validate</id>
					<action>VALIDATE</action>
					<source>
						<protocol>FS</protocol>
						<path>/opt/middleware/sft/temp/DEC36/1.0.0/working/{orderId}/{filename}</path>
					</source>
					<criteria>
						<item>
							<field>checksum</field>
							<algorithm>MD5</algorithm>
						</item>
						<item>
							<field>name</field>
							<algorithm>case-insensitive</algorithm>
						</item>
					</criteria>
				</task>
				<task>
					<id>upload-to-s3</id>
					<source>
						<protocol>FS</protocol>
						<path>/opt/middleware/sft/temp/DEC36/1.0.0/working/{orderId}/{filename}</path>
					</source>
					<destination>
						<protocol>S3</protocol>
						<region>EU_WEST_2</region>
						<path>mdg-ct/DMS/DEC36/1.0.0/to/{orderId}/{filename}</path>
						<credentials>
							<type>S3_ENCRYPTED</type>
							<resolverKey>vault://eis/sft/MDG/keys</resolverKey>
						</credentials>
					</destination>
					<metadataIncluded>true</metadataIncluded>
					<metadataExtension>_metadata.xml</metadataExtension>
				</task>
			</tasks>
		</processorConfig>
		<processorConfig>
			<id>InternalCleanup</id>
			<tasks>
				<task>
					<id>move-within-s3</id>
					<action>MOVE</action>
					<source>
						<protocol>S3</protocol>
						<region>EU_WEST_2</region>
						<path>mdg-ct/DMS/DEC36/1.0.0/working/{orderId}/{filename}</path>
						<credentials>
							<type>S3_ENCRYPTED</type>
							<resolverKey>vault://eis/sft/MDG/keys</resolverKey>
						</credentials>
					</source>
					<destination>
						<protocol>S3</protocol>
						<region>EU_WEST_2</region>
						<path>mdg-ct/DMS/DEC36/1.0.0/success/{filename}</path>
						<credentials>
							<type>S3_ENCRYPTED</type>
							<resolverKey>vault://eis/sft/MDG/keys</resolverKey>
						</credentials>
					</destination>
					<metadataIncluded>true</metadataIncluded>
					<metadataExtension>_metadata.xml</metadataExtension>
				</task>
				<task>
					<id>cleanup-in-s3</id>
					<action>DELETE</action>
					<source>
						<fsType>s3</fsType>
						<region>EU_WEST_2</region>
						<path>mdg-ct/DMS/DEC36/1.0.0/working/{orderId}/{filename}</path>
						<credentials>
							<type>S3_ENCRYPTED</type>
							<resolverKey>vault://eis/sft/MDG/keys</resolverKey>
						</credentials>
					</source>
					<metadataIncluded>true</metadataIncluded>
					<metadataExtension>_metadata.xml</metadataExtension>
				</task>
			</tasks>
		</processorConfig>
	</processors>
</journeyConfig>


